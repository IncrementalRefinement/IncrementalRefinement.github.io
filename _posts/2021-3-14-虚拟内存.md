---
layout: post
title: 重看虚拟内存
tags: [VM, OS, Thoughts]
---

最近常常被问这个问题，感觉自己对于虚拟内存的理解有一点紊乱，写一遍总结整理一下，以下内容坑定存在很多暴论&谬误，日后重看再来审核

## **What for?**

面试经常被问到虚拟内存被设计出来是为了什么，回头看自己的回答，发现存在很大的问题，我总结一下:

1. 首先虚拟内存不等于分页的虚拟内存，通过分段实现的虚拟内存也是一种设计方式，甚至可以将分段分页结合，这些都只是虚拟内存这个抽象的内部实现而已，它们不是虚拟内存本身
2. 维基中对于虚拟内存的定义如下:

    In computing, virtual memory, or virtual storage is a memory management technique that provides an "idealized abstraction of the storage resources that are actually available on a given machine" which "creates the illusion to users of a very large (main) memory"

    所以，如果让我总结的话，虚拟内存的本质就是在物理内存上进行一层抽象，可以看作一种适配器模式，将不同大小的物理内存抽象成一个相同的虚拟内存提供给所有进程。

    实现抽象、提供接口，并由相应硬件上的MMU将VA翻译成PA，具体你怎么做，进程不在乎，进程只关心自己看得到的的虚拟内存空间，我们为进程提供了一个illusion，在这个illusion中，进程认为自己享有了自己看到的所有内存空间。

    所以以后不要再扯什么分页、共享、安全性了，多捞啊....

## **Just bonus?**

上一段的末尾提到了虚拟内存带来的分页、共享、安全性等特质，我就不再多叙述了，任何书上都会提到，那么这些是什么呢？我认为这些不过是虚拟内存实现的bonus，通过做了这么一层抽象，我们可以很轻松以及优雅地达成进程访问内存的安全性、内存共享、内存去重、内存压缩、COW等优点。而分页的虚拟内存这种抽象实现啊方式更加轻松以及优雅，很大一部分操作只需要修改页表即可达成。

但这些bonus不能同于虚拟内存，上面强调了，虚拟内存是一种设计模式

## **Not just bonus**

那么这些bonus是否就不重要了呢？我认为绝不是的，虚拟内存能够被广泛应用、发扬光大离不开这些额外带来的bonus。虚拟内存作为一个优秀的设计模式降低了模块间的耦合，提供了间接又强大的抽象接口，甚至简化了硬件的设计，这些都是切切实实的好处，不应该被抹煞。
